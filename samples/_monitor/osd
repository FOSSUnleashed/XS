#! /usr/bin/env xs

ARG0 = $0
. `{cd `{dirname $ARG0}; pwd}^/osd_pipe

fn wait_and_whinge {
	msg = `{cat $OSD_PIPE}
	delay = `{echo $msg|grep -s -o '^[0-9.]\+'}
	if {!~ $delay ()} {
		delay = `{echo $delay|cut -d\' -f1}
		msg = `{echo $msg|cut -d\' -f2-}
	} else {
		delay = 3
	}
	if {pgrep -c Xorg >/dev/null} {
		active = `{bspc wm -g|cut -c2-|grep -o '\(^\|:\)[mM][^:]\+' \
			|tr -d :|grep '^M'|cut -c2-}
		left = `{xrandr|grep `{bspc query -M -m --names} \
			|grep -w $active |cut -d' ' -f3 |cut -d+ -f2}
		font = '-*-liberation mono-bold-i-*-*-*-420-*-*-*-*-iso10646-1'
		echo $msg | osd_cat -i `($left+100) -p middle -A left \
			-f $font -d $delay -s 4 -c yellow -w
	}
}

fork {while true {wait_and_whinge; sleep 1} &}
